{{/* Use a regex to match a markdown H2 header (## Title) on its own line */}}
{{ $matches := findRE "(?m)^##\\s+.*" .Inner }}
{{ $title := "" }}
{{ $id := "" }}
{{ $body := .Inner }}

{{/* If a header was found, grab it as the title and set the ID */}}
{{ if gt (len $matches) 0 }}
  {{ $title = index $matches 0 }}
  {{ $title = replaceRE "^## " "" $title }}
  {{ $body = replaceRE "(?m)^##\\s+.*\\n?" "" .Inner }}
  {{ $id = urlize $title }}
{{ else }}
  {{ $id = md5 .Inner }}
{{ end }}

<div class="card w-100 mb-3 border border-danger" data-card-id="{{ $id }}" id="{{ $id }}">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center flex-grow-1">
      <h2 class="mb-0 me-2">
        <span class="badge text-bg-danger " data-progress />
      </h2>
      <h2 class="mb-0 ms-2">
        {{- $title -}}
      </h2>
    </div>
    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
      onclick="toggleCollapseIcon('{{ $id }}')" data-bs-target="#{{ $id }}-body" aria-expanded="true"
      aria-controls="{{ $id }}-body">
      <i class="bi bi-caret-down-fill" id="{{$id}}-card-toggle-icon"></i>
    </button>
  </div>

  <div id="{{ $id }}-body" class="collapse show">
    <div class="card-body">
      {{ $lines := split $body "\n" }}
      {{ $inTable := false }}
      {{ $itemCounter := 0 }}

      {{ range $i, $line := $lines }}
        {{ $trimmedLine := trim $line " " }}

        {{ if hasPrefix $trimmedLine "###" }}
          {{/* If we were in a table, close it before adding the header */}}
          {{ if $inTable }}
            </tbody>
            </table>
            {{ $inTable = false }}
          {{ end }}
          {{/* Render the H3 header as a sub-heading */}}
          <h3 class="d-flex justify-content-center">{{ replaceRE "^###\\s*" "" $trimmedLine }}</h3>
        {{ else if hasPrefix $trimmedLine "|" }}
          {{/* If we are not in a table yet, this must be the table header */}}
          {{ if not $inTable }}
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th style="width: 5%">?</th>
                  {{ $headers := split $trimmedLine "|" }}
                  {{ range $j, $header := $headers }}
                    {{ if and (ne $j 0) (ne $j (sub (len $headers) 1)) }}
                      <th>{{ trim $header " " }}</th>
                    {{ end }}
                  {{ end }}
                </tr>
              </thead>
              <tbody class="table-group-divider">
              {{ $inTable = true }}
          {{ else if not (hasPrefix $trimmedLine "| --") }}
            {{/* This is a data row, render it with a checkbox */}}
            {{ $itemCounter = add $itemCounter 1 }}
            <tr>
              <td>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="{{ $id }}-checkbox-{{ $itemCounter }}">
                  <label class="form-check-label" for="{{ $id }}-checkbox-{{ $itemCounter }}"></label>
                </div>
              </td>
              {{ $cells := split $trimmedLine "|" }}
              {{ range $j, $cell := $cells }}
                {{ if and (ne $j 0) (ne $j (sub (len $cells) 1)) }}
                  <td>{{ markdownify (trim $cell " ") }}</td>
                {{ end }}
              {{ end }}
            </tr>
          {{ end }}
        {{ end }}
      {{ end }}
      {{/* Close the last table if we were still in one */}}
      {{ if $inTable }}
        </tbody>
        </table>
      {{ end }}
    </div>
  </div>
</div>

<script>
  function updateCardProgress(cardId) {
    const card = document.getElementById(cardId);
    if (!card) return;
    const checkboxes = card.querySelectorAll('input[type="checkbox"]');
    if (checkboxes.length === 0) return;
    
    const totalItems = checkboxes.length;
    const checkedItems = card.querySelectorAll('input[type="checkbox"]:checked').length;
    const progressText = `${checkedItems}/${totalItems}`;
    
    const progressBadge = card.querySelector('[data-progress]');
    if (progressBadge) {
      progressBadge.textContent = progressText;
    }
  }

  function toggleCollapseIcon(cardId) {
    const icon = document.getElementById(cardId + '-card-toggle-icon');
    if (!icon) return;
    if (icon.classList.contains('bi-caret-down-fill')) {
      icon.classList.remove('bi-caret-down-fill');
      icon.classList.add('bi-caret-right-fill');
    } else {
      icon.classList.remove('bi-caret-right-fill');
      icon.classList.add('bi-caret-down-fill');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.card[data-card-id]').forEach(card => {
      const cardId = card.getAttribute('data-card-id');
      const checkboxes = card.querySelectorAll('input[type="checkbox"]');
      
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          updateCardProgress(cardId);
        });
      });
      
      updateCardProgress(cardId);
    });
  });
</script>
